# 要件レビュー — REQ-REV-014～022（§2.10 追加分）

**レビュー日:** 2026-02-03  
**対象:** docs/REQUIREMENTS.md §2.10 コードレビュー対応要件（未対応・新規検出）  
**基準:** 9憲法条項、EARS 正確性、完全性、テスト可能性、一貫性、優先度、トレーサビリティ

---

## 1. サマリー評価

| 観点 | 評価 | コメント |
|------|------|----------|
| **Specification First** | ○ | コードレビュー指摘を「要件」として先に定義している。設計・実装より前にある。 |
| **Design Before Code** | ○ | 各要件に根拠・受け入れ基準があり、実装前に検証可能。 |
| **Single Source of Truth** | ○ | §2.10 が REQ-REV-014～022 の SoT。CODE_REVIEW.md・REQUIREMENTS_REVIEW_CODE_REVIEW.md は参照に徹している。 |
| **Traceability** | ○ | CODE_REVIEW §6–7・BACKLOG-REV との対応が明記されている。タスク（TSK）への分解は未実施。 |
| **Incremental Progress** | ○ | P0→P2→P3 と実施順序の目安があり、小さい単位で提供可能。 |
| **Decision Documentation** | △ | 「Node 20+ 推奨 vs instrumentation」等の選択は ADR 未記録。方針は受け入れ基準にのみ記載。 |
| **Quality Gates** | ○ | 全要件に受け入れ基準があり、ビルド・テストで検証可能。 |
| **User-Centric** | △ | ユーザー価値（信頼性・デプロイ可能性）は根拠に含まれるが、明示的な「ユーザー価値」列はない。 |
| **Continuous Learning** | ○ | コードレビューからの学習を要件化しており、バックログ昇格の記録もある。 |

**総合:** 追加要件は 9 憲法と EARS に沿っており、テスト可能性・トレーサビリティも確保されている。軽微な改善点（ユーザー価値の明示、ADR の検討、タスク分解）を推奨する。

---

## 2. 強み

- **EARS 形式の一貫性:** 全要件が "The system shall ..." または "When ..., the system shall ..." で統一されている。
- **優先度の明確さ:** P0（デプロイ不可解消）→ P2（安定性・型安全）→ P3（品質・運用）の順で妥当。
- **受け入れ基準の具体性:** 各 REQ に「何を満たせば完了か」が 1～3 項目で書かれており、テスト・レビューで検証可能。
- **影響度・対応可能性の付与:** 工数計画やスプリント配分の判断材料になっている。
- **既存要件との整合:** REQ-REV-020 が REQ-NFR-004 と矛盾しないことを受け入れ基準に含めている。
- **出典の明示:** CODE_REVIEW.md §6–7 を出典として記載し、トレーサビリティが取れている。

---

## 3. 指摘事項（重要度別）

### 3.1 High（要対応でないが推奨）

| ID | 指摘 | 該当要件 | 推奨対応 |
|----|------|----------|----------|
| RV-H1 | **タスクへの分解が未定義** | 全体 | REQ-REV-014～022 に対応する TSK-REV-014～022（または既存 TASKS.md の「未対応分」セクション）を定義し、REQ→TSK→実装のトレースを完結させる。 |
| RV-H2 | **REQ-REV-016 のパターン** | REQ-REV-016 | 要求文が "When persisting ..." で始まっているため、Event-Driven の方が EARS として自然。表のパターン列を "Event-Driven" に変更するか、現状の Ubiquitous（永続化時は常に型安全に）のままとするかを統一する。 |

### 3.2 Medium（推奨）

| ID | 指摘 | 該当要件 | 推奨対応 |
|----|------|----------|----------|
| RV-M1 | **ユーザー価値の明示** | 各 REQ | 既存 REQ-REV-001～013 と同様に「ユーザー/システム価値」を 1 行ずつ追加する（例: REQ-REV-014: 本番デプロイを可能にし、リリース障壁を除去する）。 |
| RV-M2 | **REQ-REV-014 の選択肢の記録** | REQ-REV-014 | 「Node.js 20+ を採用」か「instrumentation で polyfill」かを選んだ場合、その理由を ADR または §2.10 の「実施メモ」に残す。 |
| RV-M3 | **REQ-REV-021 のスコープ** | REQ-REV-021 | 「クリティカルな UI フロー」がどれを指すか（例: ソース一覧の表示、設定の保存）を要件または受け入れ基準に列挙すると、見積もりと検証がしやすい。 |
| RV-M4 | **REQ-REV-022 の対象 API** | REQ-REV-022 | 「少なくとも settings 等」を「settings, sources, articles のうち X 以上」のように具体化すると、完了判定が明確になる。 |

### 3.3 Low（あればよい）

| ID | 指摘 | 該当要件 | 推奨対応 |
|----|------|----------|----------|
| RV-L1 | **Optional パターンの検討** | REQ-REV-017 | "Where a singleton ... is used" は EARS の Optional（Where <feature>）に近い。表のパターン列を "Optional" にしてもよい。 |
| RV-L2 | **REQ-REV-020 と NFR の関係** | REQ-REV-020 | REQ-NFR-004 を「REQ-REV-020 により構造化ログで具体化する」と明記し、NFR→REV のトレースを 1 行追加する。 |

---

## 4. 推奨アクション

1. **タスク分解:** TASKS.md に「コードレビュー未対応分」として TSK-REV-014～022（または一括タスク）を追加し、REQ-REV-014～022 への参照を付与する。
2. **ユーザー価値の追記:** §2.10 の各 REQ 詳細に「ユーザー/システム価値」を 1 行追加する。
3. **REQ-REV-014 の決定記録:** Node 20+ 採用 or instrumentation 採用のいずれかを実施した時点で、理由を ADR または CODE_REVIEW.md の「対応済みメモ」に記載する。
4. **REQ-REV-021・022 のスコープ具体化:** 対象フロー・対象 API を箇条書きでよいので記載し、見積もりと受け入れ判定をしやすくする。
5. **REQ-REV-016 のパターン:** 現状の Ubiquitous のままで問題ないが、文面が "When persisting" のため、必要ならパターンを Event-Driven に合わせる。

---

## 5. 不足している要件の提案

| 提案ID | 内容 | 種別 |
|--------|------|------|
| RV-MISS-1 | **対象ランタイムの明文化** | 制約 |
| | REQ-REV-014 で「対象ランタイム」を要件または制約として明示する（例: 「本番環境は Node.js 20 LTS 以上とする」）。採用後は §4 制約・前提 に 1 行追加してもよい。 |
| RV-MISS-2 | **テスト用リセットのスコープ** | 非機能 |
| | REQ-REV-017 で「テスト用」とあるため、本番ビルドにリセット関数が含まれても問題ないが、バンドルから除外するかどうかを 1 行でよいので記載する（例: 開発時のみ使用、本番では未使用）。 |
| RV-MISS-3 | **構造化ログのフォーマット** | 非機能 |
| | REQ-REV-020 で「構造化ログ」の最低限のフォーマット（例: JSON の level, message, timestamp）を受け入れ基準に含めると、実装と監視側の期待が揃う。 |

---

## 6. 今後の方針（検討）

### 6.1 実施順序の推奨

1. **即時（P0）:** REQ-REV-014 のみ実施し、本番ビルド・デプロイを可能にする。
2. **次のスプリント（P2）:** REQ-REV-015（@next/swc 統一）、REQ-REV-016（as object 解消）を実施。いずれも工数小・リスク低。
3. **P3 のまとめ実施:** REQ-REV-017～019 は 1 タスクにまとめて実施可能。REQ-REV-020～022 は工数に応じて別スプリントで計画。

### 6.2 スコープ外として明示しておくもの

- **REQ-REV-021:** 「クリティカルな UI フロー」を Phase 4 完了後に定義し、Phase 5 または別フェーズでテスト追加とする方針でもよい。
- **REQ-REV-020:** 構造化ログは pino 等の導入が必要なため、運用強化フェーズ（Phase 5）でまとめて実施する方針が現実的。

### 6.3 ドキュメントの更新方針

- REQ-REV-014～022 のいずれかを完了したら、CODE_REVIEW.md の「4. 初回レビュー指摘事項の対応状況」と同様に「6. 新たに検出された問題」に対応済み行を追加する。
- REQUIREMENTS_REVIEW_CODE_REVIEW.md の §2.6 に「対応済み」列を追加し、REQ-REV-014 から順にチェックを入れていく運用を推奨する。

---

以上。追加要件（REQ-REV-014～022）は 9 憲法と EARS に適合しており、軽微な改善とタスク分解・スコープ具体化を行うことで、今後の実装と検証がより行いやすくなる。
