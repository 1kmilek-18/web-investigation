# 設計書レビュー結果

**レビュー日:** 2026-02-02  
**設計書バージョン:** SDD.md v1.1  
**タスク状況:** NEXT_TASKS.md v1.0  
**レビュー観点:** C4完全性、要件トレーサビリティ、アーキテクチャ品質、非機能要件、ADR品質

---

## 1. カバレッジ分析

### 1.1 C4モデル完全性 ✅

| レベル | 状態 | 評価 |
|--------|------|------|
| **Level 1: Context** | ✅ 完全 | 外部アクター（User, External Scheduler）、外部システム（Web Sources, Claude API, Gmail, Supabase）が明確 |
| **Level 2: Container** | ✅ 完全 | Web UI Container、API Routes Container、Database Container が定義済み |
| **Level 3: Component** | ✅ 完全 | Cron Handler、Scraper Service、Summarizer Service、Email Sender が詳細化 |
| **Level 4: Code** | ⚠️ 部分 | 実装コードは設計書の範囲外（適切） |

**評価:** C4モデルとして必要な全レベルが適切に文書化されている。

### 1.2 要件トレーサビリティ ✅

| カテゴリ | 要件数 | 設計カバー | 実装状況 |
|----------|--------|------------|----------|
| 収集（REQ-SCR-*） | 10 | ✅ 100% | ✅ Phase 1完了 |
| 要約（REQ-SUM-*） | 4 | ✅ 100% | ⏳ Phase 2未着手 |
| 配信（REQ-EML-*） | 6 | ✅ 100% | ⏳ Phase 3未着手 |
| スケジュール（REQ-SCH-*） | 4 | ✅ 100% | ✅ Phase 1完了 |
| Web UI - ソース（REQ-UI-001〜004） | 4 | ✅ 100% | ✅ API実装済み、UI未実装 |
| Web UI - 配信（REQ-UI-005〜007, 012） | 4 | ✅ 100% | ⏳ Phase 4未着手 |
| Web UI - 記事（REQ-UI-008〜011） | 4 | ✅ 100% | ✅ API実装済み、UI未実装 |
| 拡張性（REQ-EXT-*） | 2 | ✅ 100% | ✅ Phase 1完了 |
| 非機能（REQ-NFR-*, SEC-*, MET-*） | 11 | ✅ 100% | ⚠️ 部分実装 |
| ジョブ制御（REQ-JOB-*） | 2 | ✅ 100% | ✅ Phase 1完了 |
| コスト管理（REQ-COT-*） | 3 | ✅ 100% | ⏳ Phase 5未着手 |

**評価:** 全要件が設計でカバーされており、トレーサビリティマトリクス（Section 7）が明確。

---

## 2. アーキテクチャ品質評価

### 2.1 関心の分離 ✅

| コンポーネント | 責務 | 評価 |
|---------------|------|------|
| **Scraper Service** | スクレイピング専責 | ✅ 単一責任原則に準拠 |
| **Summarizer Service** | LLM要約専責 | ✅ 将来の要約エンジン切替が容易 |
| **Email Sender** | メール送信専責 | ✅ Gmail以外への拡張が容易 |
| **Cron Handler** | ジョブオーケストレーション | ✅ 各サービスを組み合わせるのみ |

**評価:** 各コンポーネントの責務が明確で、疎結合設計。

### 2.2 抽象化レベル ✅

- **API Routes**: HTTPリクエスト/レスポンスの抽象化 ✅
- **Prisma Client**: DBアクセスの抽象化 ✅
- **Service層**: ビジネスロジックの抽象化 ✅

**評価:** 適切な抽象化レベルで、実装詳細が設計書に漏れていない。

### 2.3 技術選択の妥当性 ✅

| 技術 | 選択理由 | 評価 |
|------|----------|------|
| **Next.js App Router** | フルスタック単一リポジトリ | ✅ 単一ユーザー想定に適切 |
| **Prisma + PostgreSQL** | 型安全なDBアクセス | ✅ スキーマ管理が明確 |
| **HTTP API トリガー** | デプロイ先非依存 | ✅ ADR-002で妥当性確認済み |
| **p-limit** | 並列制限の簡易実装 | ✅ ADR-004で選択理由明確 |

**評価:** 各技術選択がADRで文書化され、代替案も検討済み。

---

## 3. 非機能要件の対応状況

### 3.1 パフォーマンス ⚠️

| 要件 | 設計対応 | 実装状況 | 評価 |
|------|----------|----------|------|
| REQ-NFR-001: 5〜20記事/日 | ✅ 設計で対応可能 | ✅ 実装済み | ✅ |
| REQ-NFR-002: 3秒以内応答 | ✅ tsvector + GIN インデックス | ⏳ 全文検索未実装 | ⚠️ Phase 4で対応予定 |

**修正点:** 全文検索インデックス（SDD 5.4）は Phase 4 で実装予定だが、設計書には明記済み。

### 3.2 セキュリティ ✅

| 要件 | 設計対応 | 実装状況 | 評価 |
|------|----------|----------|------|
| REQ-SEC-001: 認証情報管理 | ✅ 環境変数 | ✅ .env 使用 | ✅ |
| REQ-SEC-002: HTTPS | ✅ 本番HTTPS必須 | ⏳ デプロイ時対応 | ✅ |
| REQ-SEC-003: Basic Auth/OAuth | ⚠️ Optional | ⏳ 未実装 | ✅ Optional要件 |
| REQ-SEC-004: レート制限 | ✅ オリジン間1200ms | ✅ 実装済み | ✅ |
| REQ-SEC-005: robots.txt | ✅ isAllowedByRobotsTxt | ✅ 実装済み | ✅ |
| REQ-SEC-006: HTMLサニタイズ | ✅ sanitize-html | ✅ 実装済み | ✅ |

**評価:** セキュリティ要件は設計・実装ともに適切に対応。

### 3.3 スケーラビリティ ✅

- **単一ユーザー想定:** REQ-NFR-003 で明確化済み ✅
- **マルチテナント不要:** 設計が単純化されている ✅

**評価:** 要件に適合した設計。

---

## 4. ADR品質評価 ✅

| ADR | 問題記述 | 代替案検討 | 結果の記録 | 評価 |
|-----|----------|------------|------------|------|
| **ADR-001** | ✅ 基盤構成の選択 | ⚠️ 代替案の記述が簡潔 | ✅ 結果明確 | ✅ |
| **ADR-002** | ✅ HTTP APIトリガー | ✅ crontab/Vercel両対応 | ✅ 結果明確 | ✅ |
| **ADR-003** | ✅ 重複記事の扱い | ✅ 代替案検討済み | ✅ 結果明確 | ✅ |
| **ADR-004** | ✅ 並列制限 | ✅ p-limit/p-queue選択 | ✅ 将来拡張可能 | ✅ |
| **ADR-005** | ✅ 重複実行防止 | ✅ DBロック/statusチェック | ✅ 結果明確 | ✅ |
| **ADR-006** | ✅ 全文検索 | ✅ tsvector/pg_bigm検討 | ✅ 初期実装は簡易版 | ✅ |

**評価:** 全ADRが問題・決定・結果を明確に記録。ADR-001の代替案記述は簡潔だが、技術選択の妥当性は十分。

---

## 5. 実装状況との整合性チェック

### 5.1 実装済み ✅

| 項目 | 設計書 | 実装 | 整合性 |
|------|--------|------|--------|
| **Prisma Schema** | SDD 5.3 | ✅ schema.prisma | ✅ 完全一致 |
| **Source CRUD API** | SDD 9.2 | ✅ /api/sources | ✅ 実装済み |
| **Article CRUD API** | SDD 9.3, 9.4 | ✅ /api/articles | ✅ 実装済み |
| **Cron Handler** | SDD 4.2, 9.1 | ✅ /api/cron/daily | ✅ 実装済み |
| **Job Control** | SDD 9.7, 9.8 | ✅ /api/jobs/manual, /api/jobs/stop | ✅ 実装済み |
| **Scraper Service** | SDD 4.3 | ✅ src/lib/scraper.ts | ✅ 実装済み |

### 5.2 設計書に定義されているが未実装 ⚠️

| 項目 | 設計書 | 実装 | 影響 |
|------|--------|------|------|
| **Settings API** | SDD 9.5 | ❌ 未実装 | ⚠️ Phase 4で必要 |
| **Metrics API** | SDD 9.6 | ❌ 未実装 | ⚠️ Phase 5で必要 |
| **Summarizer Service** | SDD 4.1, 4.2 | ❌ 未実装 | ⏳ Phase 2で実装予定 |
| **Email Sender** | SDD 4.1, 4.2 | ❌ 未実装 | ⏳ Phase 3で実装予定 |
| **Web UI** | SDD 3.1 | ⚠️ ランディングのみ | ⏳ Phase 4で実装予定 |
| **全文検索インデックス** | SDD 5.4 | ❌ 未実装 | ⏳ Phase 4で実装予定 |

**評価:** Phase 1完了時点では設計書と実装の整合性は良好。未実装項目は次フェーズで対応予定。

---

## 6. 修正点・改善提案

### 6.1 設計書の修正が必要な項目

#### 🔴 高優先度

**なし** - 設計書は現時点で適切。

#### 🟡 中優先度

1. **Settings API の実装タイミング明確化**
   - **現状:** SDD 9.5に定義されているが、Phase 1では未実装
   - **提案:** NEXT_TASKS.md の Phase 4 に Settings API 実装を明記（現在は UI のみ）
   - **影響:** Phase 3（配信）で Settings が必要なため、Phase 3 前に Settings API を実装すべき

2. **Cron Handler のコスト管理ロジック詳細化**
   - **現状:** SDD 4.2 の「5-a. コスト管理チェック」が簡潔
   - **提案:** 月次コスト計算ロジック（月初日判定、累計計算）を詳細化
   - **影響:** Phase 5 実装時の明確性向上

#### 🟢 低優先度（将来の拡張）

1. **ADR-001 の代替案詳細化**
   - **現状:** 技術選択の代替案が簡潔
   - **提案:** 各技術（Next.js vs Remix, Prisma vs TypeORM）の比較表を追加
   - **影響:** 将来の技術選定時の参考

2. **全文検索の日本語対応計画**
   - **現状:** SDD 5.4 で「将来的に pg_bigm 拡張を検討」と記載
   - **提案:** 日本語対応が必要になった場合の実装計画（ADR化）を検討
   - **影響:** 将来の拡張性

### 6.2 タスク状況との整合性確認

#### ✅ 整合している項目

- Phase 1 の完了状況と設計書の定義が一致
- Phase 2〜5 の未実装項目が設計書で適切に定義されている

#### ⚠️ 調整が必要な項目

1. **Settings API の実装タイミング**
   - **NEXT_TASKS.md:** Phase 4（Web UI）に含まれている
   - **設計書:** SDD 9.5 で API 仕様が定義済み
   - **問題:** Phase 3（配信）で Settings が必要なため、Phase 3 前に Settings API を実装すべき
   - **修正提案:** NEXT_TASKS.md の Phase 3 前に「Settings API 実装」タスクを追加

2. **Metrics API の実装タイミング**
   - **NEXT_TASKS.md:** Phase 5（運用強化）に含まれている
   - **設計書:** SDD 9.6 で API 仕様が定義済み
   - **評価:** タイミングは適切（Phase 5 で実装）

---

## 7. リスク評価

### 7.1 技術リスク 🟢 低

| リスク | 影響度 | 対策 | 評価 |
|--------|--------|------|------|
| **PostgreSQL 全文検索の日本語対応** | 低 | pg_bigm 拡張で対応可能 | ✅ 将来対応で十分 |
| **Claude API のレート制限** | 中 | リトライロジック実装済み | ✅ 設計で対応済み |
| **Gmail API の認証** | 低 | SMTP/API 両対応可能 | ✅ 設計で対応済み |

### 7.2 実装リスク 🟡 中

| リスク | 影響度 | 対策 | 評価 |
|--------|--------|------|------|
| **Phase 3 で Settings API 未実装** | 高 | Phase 3 前に Settings API を実装 | ⚠️ タスク調整が必要 |
| **全文検索のパフォーマンス** | 中 | tsvector で対応、簡易版も用意 | ✅ 設計で対応済み |

### 7.3 運用リスク 🟢 低

| リスク | 影響度 | 対策 | 評価 |
|--------|--------|------|------|
| **コスト上限の超過** | 中 | REQ-COT-002, REQ-COT-003 で対応 | ✅ 設計で対応済み |
| **ジョブの長時間実行** | 低 | 停止機能実装済み | ✅ 設計で対応済み |

---

## 8. 総合評価

### 8.1 設計書の品質 ✅ 優秀

- **C4完全性:** ✅ 全レベルが適切に文書化
- **要件トレーサビリティ:** ✅ 100% カバー
- **アーキテクチャ品質:** ✅ 関心の分離、抽象化、技術選択が適切
- **非機能要件:** ✅ パフォーマンス、セキュリティ、スケーラビリティに対応
- **ADR品質:** ✅ 問題・決定・結果が明確

### 8.2 実装との整合性 ✅ 良好

- **Phase 1:** ✅ 設計書と実装が一致
- **Phase 2〜5:** ⏳ 未実装だが設計書で定義済み

### 8.3 改善が必要な点 ⚠️ 軽微

1. **Settings API の実装タイミング調整**（NEXT_TASKS.md）
2. **コスト管理ロジックの詳細化**（SDD 4.2）

---

## 9. 推奨アクション

### 即座に対応（Phase 1 完了時）

1. ✅ **設計書レビュー完了** - 本レビュー完了
2. ⚠️ **NEXT_TASKS.md 更新** - Settings API を Phase 3 前に追加
3. ✅ **Phase 2 開始準備** - 要約機能の実装に着手

### Phase 2 開始前

1. **Settings API 実装** - Phase 3 で必要になるため、Phase 2 と並行して実装を検討
2. **コスト管理ロジック詳細化** - SDD 4.2 の「5-a. コスト管理チェック」を詳細化

### Phase 3 開始前

1. **Settings API 必須** - Phase 3（配信）で Settings が必要なため、事前に実装完了していること

---

## 10. 結論

**設計書（SDD.md v1.1）は高品質で、要件を適切にカバーしている。**

- ✅ C4モデルとして完全
- ✅ 要件トレーサビリティ 100%
- ✅ アーキテクチャ品質が高い
- ✅ 実装との整合性が良好

**軽微な改善点:**
- ⚠️ Settings API の実装タイミングを Phase 3 前に調整
- 🟡 コスト管理ロジックの詳細化（Phase 5 実装時に明確化）

**次のステップ:**
1. NEXT_TASKS.md を更新（Settings API を Phase 3 前に追加）
2. Phase 2（要約）の実装に着手

---

**レビュー完了日:** 2026-02-02  
**次回レビュー推奨:** Phase 2 完了時、または Phase 3 開始前
