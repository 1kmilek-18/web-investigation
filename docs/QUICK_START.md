# Web Investigation クイックスタートガイド

## 🚀 起動方法

開発サーバーは既に起動しています。ブラウザで以下にアクセスしてください：

**http://localhost:3000**

## 📋 使い方

### 1. ホーム画面

トップページから各機能にアクセスできます：
- **記事一覧**: 収集された記事を閲覧・検索
- **ソース設定**: 収集対象のWebサイトを管理
- **配信設定**: メール配信の設定を変更

### 2. ソース設定（初回セットアップ必須）

1. **ソース設定**ページに移動
2. **ソースを追加**ボタンをクリック
3. 以下を入力：
   - **URL**: 収集したいWebサイトのURL
   - **タイプ**: 
     - `単一記事URL`: 1つの記事ページのURL
     - `一覧ページURL`: 複数の記事が一覧になっているページのURL
   - **CSSセレクタ**（オプション）: 記事本文を抽出するCSSセレクタ

**例:**
- 単一記事: `https://example.com/article/123`
- 一覧ページ: `https://example.com/articles`

### 3. 配信設定（初回セットアップ必須）

1. **配信設定**ページに移動
2. 以下を設定：
   - **配信時刻**: 日次ジョブの実行時刻（例: 09:00）
   - **受信メールアドレス**: メールを受け取るアドレス
   - **0件時の動作**: 
     - `メールを送信しない`: 新規記事がない場合はメールを送らない
     - `通知メールを送信`: 新規記事がない場合も通知メールを送る
   - **コスト管理**（オプション）:
     - 月次コスト上限: Claude APIの使用料上限（USD）
     - 警告閾値: 上限の何%で警告するか（0〜1）

3. **設定を保存**ボタンをクリック

### 4. メール送信のテスト

メールが届かない場合は、まず送信テストで設定を確認してください：

```bash
curl -X POST http://localhost:3000/api/test-email \
  -H "Authorization: Bearer YOUR_CRON_SECRET" \
  -H "Content-Type: application/json" \
  -d '{}'
```

- 成功時: 設定済みの受信アドレスにテストメールが送信されます
- 失敗時: 診断情報（GMAIL_USER/GMAIL_APP_PASSWORD の設定状況など）が返ります
- **迷惑メールフォルダも必ず確認**してください（Gmail→Yahoo などはフィルタされやすいです）

### 5. 手動ジョブ実行（テスト用）

API経由で手動ジョブを実行できます：

```bash
curl -X POST http://localhost:3000/api/jobs/manual \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

**注意**: `CRON_SECRET`環境変数を設定する必要があります。

### 6. 記事の閲覧

1. **記事一覧**ページに移動
2. 検索・フィルタ機能を使用：
   - **キーワード検索**: タイトル・要約で検索
   - **日付範囲**: 開始日・終了日で絞り込み
3. 記事をクリックして詳細を表示

## ⚙️ 環境変数の設定

`.env`ファイルに以下を設定してください：

```bash
# データベース（必須）
DATABASE_URL="postgresql://..."

# Claude API（要約機能に必須）
ANTHROPIC_API_KEY="sk-ant-..."

# Gmail送信（配信機能に必須）
GMAIL_USER="your-app@gmail.com"
GMAIL_APP_PASSWORD="your-16-char-app-password"

# ジョブ実行認証（手動ジョブ実行に必須）
CRON_SECRET="your-secret-key"
```

### Gmailアプリパスワードの取得方法

1. Googleアカウントで2段階認証を有効化
2. https://myaccount.google.com/apppasswords にアクセス
3. 「アプリを選択」→「その他（カスタム名）」を選択
4. 名前を入力（例: "Web Investigation"）
5. 生成された16文字のパスワードをコピーして`.env`に設定

## 🔍 動作確認の流れ

1. **ソースを追加**
   - テスト用のWebサイトURLを追加

2. **配信設定を確認**
   - 受信メールアドレスが設定されているか確認

3. **手動ジョブを実行**
   - API経由でジョブを実行して動作確認

4. **記事を確認**
   - 記事一覧ページで収集された記事を確認
   - 要約が生成されているか確認

5. **メール配信を確認**
   - 設定したメールアドレスにメールが届くか確認

## 🐛 トラブルシューティング

### データベース接続エラー

- `.env`の`DATABASE_URL`が正しく設定されているか確認
- Supabaseの接続文字列が正しいか確認

### 要約が生成されない

- `ANTHROPIC_API_KEY`が設定されているか確認
- Claude APIのクォータを確認

### メールが送信されない

- `GMAIL_USER`と`GMAIL_APP_PASSWORD`が設定されているか確認
- Gmailアプリパスワードが正しいか確認
- 2段階認証が有効になっているか確認

### ジョブが実行されない

- `CRON_SECRET`が設定されているか確認
- 外部スケジューラ（crontab、Vercel Cron等）の設定を確認

## 📚 次のステップ

- Phase 5（運用強化）の実装
- メトリクス・コスト管理UIの追加
- 全文検索インデックスの実装
